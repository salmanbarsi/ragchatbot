{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///D:/Nxtjs/rag-chatbot/src/lib/db-config.ts"],"sourcesContent":["import { drizzle } from \"drizzle-orm/neon-http\";\r\nimport { neon } from \"@neondatabase/serverless\";\r\nimport {config} from 'dotenv';\r\n\r\nconfig({path: '.env.local'});\r\nconst client = neon(process.env.NEON_DATABASE_URL!);\r\nexport const db = drizzle(client);\r\n\r\nexport default db;"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,IAAA,iJAAM,EAAC;IAAC,MAAM;AAAY;AAC1B,MAAM,SAAS,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,iBAAiB;AAC1C,MAAM,KAAK,IAAA,qKAAO,EAAC;uCAEX"}},
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///D:/Nxtjs/rag-chatbot/src/lib/db-schema.ts"],"sourcesContent":["import { pgTable, serial, text, vector, index } from \"drizzle-orm/pg-core\";\r\n\r\nexport const documents = pgTable(\r\n  \"documents\",\r\n  {\r\n    id: serial(\"id\").primaryKey(),\r\n    content: text(\"content\").notNull(),\r\n    embedding: vector(\"embedding\", { dimensions: 768 }),\r\n  },\r\n  (table) => [\r\n    index(\"embeddingIndex\").using(\r\n      \"hnsw\",\r\n      table.embedding.op(\"vector_cosine_ops\")\r\n    ),\r\n  ]\r\n);\r\n\r\nexport type InsertDocument = typeof documents.$inferInsert;\r\nexport type SelectDocument = typeof documents.$inferSelect;"],"names":[],"mappings":";;;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEO,MAAM,YAAY,IAAA,kKAAO,EAC9B,aACA;IACE,IAAI,IAAA,6KAAM,EAAC,MAAM,UAAU;IAC3B,SAAS,IAAA,yKAAI,EAAC,WAAW,OAAO;IAChC,WAAW,IAAA,iMAAM,EAAC,aAAa;QAAE,YAAY;IAAI;AACnD,GACA,CAAC,QAAU;QACT,IAAA,kKAAK,EAAC,kBAAkB,KAAK,CAC3B,QACA,MAAM,SAAS,CAAC,EAAE,CAAC;KAEtB"}},
    {"offset": {"line": 103, "column": 0}, "map": {"version":3,"sources":["file:///D:/Nxtjs/rag-chatbot/src/lib/embeddings.ts"],"sourcesContent":["import { OpenRouterCore } from \"@openrouter/sdk/core.js\";\r\nimport { embeddingsGenerate } from \"@openrouter/sdk/funcs/embeddingsGenerate.js\";\r\n\r\n\r\nconst openRouter = new OpenRouterCore({\r\n  apiKey: process.env[\"OPENROUTER_API_KEY\"] ?? \"\",\r\n});\r\n\r\nexport async function generateEmbeddingsMany(texts: string[]) {\r\n  const cleaned = texts.map((t) => t.replace(/\\n/g, \" \"));\r\n  const res = await embeddingsGenerate(openRouter, {\r\n    input: cleaned,\r\n    model: \"thenlper/gte-base\",\r\n  });\r\n  if (res.ok) {\r\n    const { value: result } = res;\r\n    console.log(result);\r\n    return result\r\n  } else {\r\n    console.log(\"embeddingsGenerate failed:\", res.error);\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGA,MAAM,aAAa,IAAI,sKAAc,CAAC;IACpC,QAAQ,QAAQ,GAAG,CAAC,qBAAqB,IAAI;AAC/C;AAEO,eAAe,uBAAuB,KAAe;IAC1D,MAAM,UAAU,MAAM,GAAG,CAAC,CAAC,IAAM,EAAE,OAAO,CAAC,OAAO;IAClD,MAAM,MAAM,MAAM,IAAA,iMAAkB,EAAC,YAAY;QAC/C,OAAO;QACP,OAAO;IACT;IACA,IAAI,IAAI,EAAE,EAAE;QACV,MAAM,EAAE,OAAO,MAAM,EAAE,GAAG;QAC1B,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT,OAAO;QACL,QAAQ,GAAG,CAAC,8BAA8B,IAAI,KAAK;IACrD;AACF"}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"sources":["file:///D:/Nxtjs/rag-chatbot/src/lib/search.ts"],"sourcesContent":["// src/lib/search.ts\r\nimport { cosineDistance, desc, gt, sql } from \"drizzle-orm\";\r\nimport { db } from \"./db-config\";\r\nimport { documents } from \"./db-schema\";\r\nimport { generateEmbeddingsMany } from \"./embeddings\";\r\n\r\n/**\r\n * Search for similar documents using Drizzle ORM with cosineDistance\r\n */\r\nexport async function searchDocuments(\r\n  query: string[],\r\n  limit: number = 5,\r\n  threshold: number = 0.5\r\n) {\r\n  // Generate embedding for the search query\r\n  const embedding:any = await generateEmbeddingsMany(query);\r\n\r\n  // Calculate similarity using Drizzle's cosineDistance function\r\n  // This creates a SQL expression for similarity calculation\r\n  const similarity = sql<number>`1 - (${cosineDistance(\r\n    documents.embedding,\r\n    embedding\r\n  )})`;\r\n\r\n  // Use Drizzle's query builder for the search\r\n  const similarDocuments = await db\r\n    .select({\r\n      id: documents.id,\r\n      content: documents.content,\r\n      similarity,\r\n    })\r\n    .from(documents)\r\n    .where(gt(similarity, threshold))\r\n    .orderBy(desc(similarity))\r\n    .limit(limit);\r\n\r\n  return similarDocuments;\r\n}"],"names":[],"mappings":"AAAA,oBAAoB;;;;;AACpB;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;AAKO,eAAe,gBACpB,KAAe,EACf,QAAgB,CAAC,EACjB,YAAoB,GAAG;IAEvB,0CAA0C;IAC1C,MAAM,YAAgB,MAAM,IAAA,oJAAsB,EAAC;IAEnD,+DAA+D;IAC/D,2DAA2D;IAC3D,MAAM,aAAa,qJAAG,AAAQ,CAAC,KAAK,EAAE,IAAA,gLAAc,EAClD,yIAAS,CAAC,SAAS,EACnB,WACA,CAAC,CAAC;IAEJ,6CAA6C;IAC7C,MAAM,mBAAmB,MAAM,kIAAE,CAC9B,MAAM,CAAC;QACN,IAAI,yIAAS,CAAC,EAAE;QAChB,SAAS,yIAAS,CAAC,OAAO;QAC1B;IACF,GACC,IAAI,CAAC,yIAAS,EACd,KAAK,CAAC,IAAA,0KAAE,EAAC,YAAY,YACrB,OAAO,CAAC,IAAA,wKAAI,EAAC,aACb,KAAK,CAAC;IAET,OAAO;AACT"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///D:/Nxtjs/rag-chatbot/src/app/api/chat/route.ts"],"sourcesContent":["import {  UIMessage, convertToModelMessages, streamText, tool, UIDataTypes, InferUITools, stepCountIs } from \"ai\";\r\nimport { createOpenRouter } from \"@openrouter/ai-sdk-provider\";\r\nimport { z } from \"zod\"\r\nimport { searchDocuments } from \"@/lib/search\";\r\n\r\nconst tools = {\r\n  searchKnowledgeBase : tool({\r\n    description: \"Search the knowledge base for relevant information\",\r\n    inputSchema: z.object({\r\n      query: z.string().describe(\"The search query to find relevant documents\"),\r\n    }),\r\n    execute: async({query}:any) => {\r\n      try {\r\n        const results = await searchDocuments(query, 3, 0.5);\r\n\r\n        if(results.length === 0){\r\n          return \"No relevant information found in the knowledge base.\";\r\n        }\r\n\r\n        // Format results for the AI\r\n        const formattedResults = results\r\n          .map((r, i) => `[${i + 1}] ${r.content}`)\r\n          .join(\"\\n\\n\");\r\n\r\n        return formattedResults;\r\n        \r\n      } catch (error) {\r\n        console.error(\"Search error\", error)\r\n        return \"Error searching the knowledge base.\";\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nexport type ChatTools = InferUITools<typeof tools>;\r\nexport type ChatMessage = UIMessage<never, UIDataTypes, ChatTools>;\r\n\r\nconst openrouter = createOpenRouter({\r\n  apiKey: process.env.OPENROUTER_API_KEY!,  \r\n});\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const { messages }: { messages: ChatMessage[] } = await request.json();\r\n\r\n    const result = streamText({\r\n      model: openrouter.chat(\"nvidia/nemotron-nano-12b-v2-vl:free\"),\r\n      messages: convertToModelMessages(messages),\r\n      tools,\r\n      system: `You are a helpful assistant with access to a knowledge base. \r\n          When users ask questions, search the knowledge base for relevant information.\r\n          Always search before answering if the question might relate to uploaded documents.\r\n          Base your answers on the search results when available. Give concise answers that correctly answer what the user is asking for. Do not flood them with all the information from the search results.`,\r\n      stopWhen: stepCountIs(2),\r\n    });\r\n\r\n    return result.toUIMessageStreamResponse();\r\n  } catch (error) {\r\n    console.error(\"Error in POST /chat:\", error);\r\n    return Response.json({ text: \"Error generating response.\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,QAAQ;IACZ,qBAAsB,IAAA,4LAAI,EAAC;QACzB,aAAa;QACb,aAAa,oLAAC,CAAC,MAAM,CAAC;YACpB,OAAO,oLAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B;QACA,SAAS,OAAM,EAAC,KAAK,EAAK;YACxB,IAAI;gBACF,MAAM,UAAU,MAAM,IAAA,yIAAe,EAAC,OAAO,GAAG;gBAEhD,IAAG,QAAQ,MAAM,KAAK,GAAE;oBACtB,OAAO;gBACT;gBAEA,4BAA4B;gBAC5B,MAAM,mBAAmB,QACtB,GAAG,CAAC,CAAC,GAAG,IAAM,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,EACvC,IAAI,CAAC;gBAER,OAAO;YAET,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,gBAAgB;gBAC9B,OAAO;YACT;QACF;IACF;AACF;AAKA,MAAM,aAAa,IAAA,6LAAgB,EAAC;IAClC,QAAQ,QAAQ,GAAG,CAAC,kBAAkB;AACxC;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,GAAgC,MAAM,QAAQ,IAAI;QAEpE,MAAM,SAAS,IAAA,oKAAU,EAAC;YACxB,OAAO,WAAW,IAAI,CAAC;YACvB,UAAU,IAAA,gLAAsB,EAAC;YACjC;YACA,QAAQ,CAAC;;;6MAG8L,CAAC;YACxM,UAAU,IAAA,qKAAW,EAAC;QACxB;QAEA,OAAO,OAAO,yBAAyB;IACzC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,SAAS,IAAI,CAAC;YAAE,MAAM;QAA6B,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}